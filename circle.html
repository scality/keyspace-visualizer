<!DOCTYPE html>
<meta charset="utf-8">
<style>
    svg {
        background-color: gray;
    }
</style>
<script src="js/d3.v3.js"></script>
<body>
    <div class="labelType" style="position:absolute; margin-top: 30px">
        <input type="radio" name="labelType" value="cos0">Cos0<br>
        <input type="radio" name="labelType" value="cos1">Cos1<br>
        <input type="radio" name="labelType" value="cos2" checked="checked">Cos2<br>
        <input type="radio" name="labelType" value="cos3">Cos3<br>
        <input type="radio" name="labelType" value="cos4">Cos4<br>
        <input type="radio" name="labelType" value="cos5">Cos5<br>
    </div>
    <svg width="1000" height="500"></svg>

<script>
// List of predefined angles
var coses = {
    "cos0": { "schema": 6, "part": [0] },
    "cos1": { "schema": 6, "part": [0, 3] },
    "cos2": { "schema": 6, "part": [0, 2, 4] },
    "cos3": { "schema": 6, "part": [0, 3, 2, 5] },
    "cos4": { "schema": 6, "part": [0, 3, 2, 5, 1] },
    "cos5": { "schema": 6, "part": [0, 3, 2, 5, 1, 4] }
};

var width = 1000,
    height = 500,
    radius = Math.min(width, height) * 0.5;

var visu = d3.select("svg")
visu
    .append("g")
    .attr("class", "visu")
visu
    .append("g")
    .attr("class", "lines")
visu
    .append("g")
    .attr("class", "arrows")

// Starting draw point in the svg
// rotate -90Â° to start at noon
visu.selectAll("g")
    .attr("transform", "translate(" + width / 4 + "," + height / 2 + ") rotate(-90, 0, 0)");

// Draw circle
visu.select("g.visu")
    .append("circle")
    .attr("class", "circle")
    .attr("y1", -(radius * 0.8))
    .attr("y2", (radius * 0.8))
    .attr("r", (radius * 0.8))
    .style("fill", "none")
    .style("stroke", "blue")
    .style("stroke-width", "5px")

function cosDegree(degrees) {
    return Math.cos( degrees * Math.PI / 180);
}
function sinDegree(degrees) {
    return Math.sin( degrees * Math.PI / 180);
}

/**
 * Takes schema and slice numbers
 * Return array of angles
 */
function partsToAngles(data) {
    angles = [],
    x = -1;
    while(++x < data.schema) {
        var n = data.part.length,
            y = -1;
        while(++y < n) {
            if( x == data.part[y] ) {
                angles.push( { "angle": (360 / data.schema * x) } );
                break;
            }
        }
    }
    return angles;
};

// default view at init
change( partsToAngles(coses.cos2) );
// hanle other views
d3.selectAll('input[name="labelType"]')
    .on("change", function() {
        labelType = this.value
        var angles = partsToAngles(coses[labelType]);
        change(angles);
    });

// Display the angles
function change(data) {
    var radline = radius * 0.9

    var lines = visu.select(".lines")
        .selectAll("line")
        .data(data, function(d) { return d.angle; });

    /*
    lines.enter()
        .append("g")
        .attr("class", "angleSweep")
        .append("polyline")
        .attr("points", function(d) {
            var paira = "0, 0";
            var pairb = cosDegree(d.angle) * radline +","+sinDegree(d.angle) * radline;
            var pairc = "2, 2; 
            return paira + " " + pairb + " " + pairc;
        })
        .style("fill", "none")
        .style("stroke", "black")
        .style("stroke-width", "2px")
    */
    lines.enter()
        .append("g")
        .attr("class", "angleSweep")
        .append("line")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", function(d) { return cosDegree(d.angle) * radline; })
        .attr("y2", function(d) { return sinDegree(d.angle) * radline; })
        .style("fill", "none")
        .style("stroke", "black")
        .style("stroke-width", "2px")
    
    lines.exit()
        .remove();

    var anchor = visu.select(".arrows")
        .selectAll("circle")
        .data(data, function(d) { return d.angle; });

    anchor.enter()
        .append("g")
        .attr("class", "anchor")
        .append("circle")
        .attr("cx", function(d) { return cosDegree(d.angle) * radline; })
        .attr("cy", function(d) { return sinDegree(d.angle) * radline; })
        .attr("r", 5)
        .style("fill", function(d, i) { if(i == 0) { return "green" } else { return "blue" }; })
        .style("stroke", "black")
        .style("stroke-width", "1px")

    anchor
        .on('mousedown', function(d, i) {
            var timedOut = 0
            d3.select("svg")
                .on('mousemove', function(elem, i) {

                    if(!timedOut) {
                        var x = (width/4) - d3.mouse(this)[0];
                        var y = (height/2) - d3.mouse(this)[1];
                        var rad = Math.atan2(y, x); // In radians
                        var deg = rad * (180 / Math.PI) + 180
                        //console.log("x:"+x+" y:"+y+" rad:"+rad+" deg:"+deg)
                        visu.selectAll("g.arrows, g.lines")
                            .attr("transform", "translate(" + width / 4 + "," + height / 2 + ") rotate("+deg+", 0, 0)");
                    }

                    timedOut = 1
                    // add 10ms latency to not overlad the cpu
                    setTimeout(function() { timedOut = 0 }, 10)
                })
                // Detect mouseup on the whole svg
         .on('mouseup', function(e) {
            d3.select("svg")
                 .on('mousemove', null);
        })
    });

    
    anchor.exit()
        .remove();
}
</script> 

</body>
</html>
